<link rel="stylesheet" href="/assets/css/pages/order-confirmation.css">

<div class="container section-padding">
    <div class="order-confirmation-wrapper">
        <div class="order-confirmation-card">
            <div class="confirmation-header">
                <div class="success-icon">âœ“</div>
                <h1 class="confirmation-title">SipariÅŸiniz OluÅŸturuldu!</h1>
                <p class="confirmation-subtitle">SipariÅŸiniz baÅŸarÄ±yla alÄ±ndÄ± ve iÅŸleme alÄ±ndÄ±.</p>
            </div>

            <div class="confirmation-content">
                <div class="info-section">
                    <h2 class="section-title">SipariÅŸ Bilgileri</h2>
                    <div id="loading-message" style="text-align: center; padding: 2rem; color: #666;">
                        <p>SipariÅŸ bilgileri yÃ¼kleniyor...</p>
                    </div>
                    <div id="order-info" style="display: none;">
                    <div class="info-item">
                        <div class="info-label">
                            <span class="info-icon">ğŸ“¦</span>
                            <span>SipariÅŸ ID</span>
                        </div>
                        <div class="info-value" id="order-number">-</div>
                    </div>

                    <div class="info-item">
                        <div class="info-label">
                            <span class="info-icon">ğŸª</span>
                            <span>Restoran</span>
                        </div>
                        <div class="info-value" id="restaurant-name">-</div>
                    </div>

                    <div class="info-item">
                        <div class="info-label">
                            <span class="info-icon">ğŸ“</span>
                            <span>Teslimat Adresi</span>
                        </div>
                        <div class="info-value" id="delivery-address">-</div>
                    </div>

                    <div class="info-item">
                        <div class="info-label">
                            <span class="info-icon">ğŸ’°</span>
                            <span>Toplam Tutar</span>
                        </div>
                        <div class="info-value total-amount" id="total-amount">-</div>
                    </div>

                    <div class="info-item">
                        <div class="info-label">
                            <span class="info-icon">ğŸ“…</span>
                            <span>SipariÅŸ Tarihi</span>
                        </div>
                        <div class="info-value" id="order-date">-</div>
                    </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <a href="/buyer/orders" class="btn btn-primary">SipariÅŸlerimi GÃ¶rÃ¼ntÃ¼le</a>
                    <a href="/" class="btn btn-secondary">Ana Sayfaya DÃ¶n</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async function() {
    // EJS'den gelen orderId'yi kullan
    const orderId = <%= typeof orderId !== 'undefined' ? orderId : 'null' %>;
    
    if (!orderId) {
        // OrderId yoksa sipariÅŸler sayfasÄ±na yÃ¶nlendir
        window.location.href = '/buyer/orders';
        return;
    }
    
    try {
        const baseUrl = window.getBaseUrl ? window.getBaseUrl() : '';
        const apiUrl = `${baseUrl}/api/orders/${orderId}`;
        console.log('ğŸ“¦ SipariÅŸ bilgileri yÃ¼kleniyor:', apiUrl);
        console.log('ğŸ“¦ Order ID:', orderId);
        
        const response = await fetch(apiUrl, {
            credentials: 'include'
        });
        
        console.log('ğŸ“¦ Response status:', response.status, response.statusText);
        
        if (!response.ok) {
            let errorData;
            try {
                errorData = await response.json();
            } catch (e) {
                errorData = { message: await response.text() };
            }
            console.error('âŒ API hatasÄ±:', response.status, errorData);
            throw new Error(errorData.message || `SipariÅŸ bilgileri yÃ¼klenemedi: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('ğŸ“¦ API yanÄ±tÄ±:', data);
        
        if (!data.success || !data.data) {
            console.error('âŒ SipariÅŸ bulunamadÄ± veya veri formatÄ± hatalÄ±:', data);
            throw new Error(data.message || 'SipariÅŸ bulunamadÄ±');
        }
        
        const order = data.data;
        
        // Loading mesajÄ±nÄ± gizle, order info'yu gÃ¶ster
        const loadingEl = document.getElementById('loading-message');
        const orderInfoEl = document.getElementById('order-info');
        if (loadingEl) loadingEl.style.display = 'none';
        if (orderInfoEl) orderInfoEl.style.display = 'block';
        
        // Bilgileri doldur
        const orderNumberEl = document.getElementById('order-number');
        const restaurantEl = document.getElementById('restaurant-name');
        const addressEl = document.getElementById('delivery-address');
        const totalEl = document.getElementById('total-amount');
        const dateEl = document.getElementById('order-date');
        
        if (orderNumberEl) {
            orderNumberEl.textContent = order.orderNumber || `#${order.id}`;
        }
        
        if (restaurantEl) {
            restaurantEl.textContent = order.seller?.name || 'Restoran bilgisi yok';
        }
        
        if (addressEl) {
            const address = order.address;
            if (address && address.full) {
                addressEl.textContent = address.full;
            } else if (address && address.addressLine) {
                addressEl.textContent = `${address.addressLine}, ${address.district || ''}, ${address.city || ''}`;
            } else {
                addressEl.textContent = 'Adres bilgisi yok';
            }
        }
        
        if (totalEl) {
            const formatTL = window.formatTL || ((amount) => {
                return Number(amount || 0).toLocaleString('tr-TR', {
                    style: 'currency',
                    currency: 'TRY'
                });
            });
            totalEl.textContent = formatTL(order.total);
        }
        
        if (dateEl) {
            dateEl.textContent = order.date || new Date().toLocaleString('tr-TR');
        }
        
    } catch (error) {
        console.error('SipariÅŸ bilgileri yÃ¼kleme hatasÄ±:', error);
        const loadingEl = document.getElementById('loading-message');
        if (loadingEl) {
            loadingEl.innerHTML = `
                <div style="color: #dc3545; padding: 1rem; background: #f8d7da; border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Hata:</strong> ${error.message || 'SipariÅŸ bilgileri yÃ¼klenirken bir hata oluÅŸtu.'}
                </div>
                <p>SipariÅŸler sayfasÄ±na yÃ¶nlendiriliyorsunuz...</p>
            `;
        }
        setTimeout(() => {
            window.location.href = '/buyer/orders';
        }, 3000);
    }
});
</script>

